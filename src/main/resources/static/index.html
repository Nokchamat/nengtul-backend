<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat Application</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
</head>

<body>
<h1>Chat Application</h1>
<div id="chat-box">
  <!-- 채팅 메시지가 표시될 영역 -->
</div>
<input type="text" id="sender-id-input" placeholder="보내는 사용자 ID 입력">
<input type="text" id="receiver-id-input" placeholder="받는 사용자 ID 입력">
<button onclick="connectAndJoinChat()">입장</button>
<br>
<input type="text" id="message-input" placeholder="메시지 입력">
<button onclick="sendMessage()" id="send-button" disabled>전송</button>

<script>
  var stompClient = null;
  var senderId = null;
  var receiverId = null;
  var roomId = null;

  function connectAndJoinChat() {
    // 보내는 사용자 ID, 받는 사용자 ID를 입력받습니다.
    senderId = document.getElementById("sender-id-input").value.trim();
    receiverId = document.getElementById("receiver-id-input").value.trim();
    if (senderId === "" || receiverId === "") {
      alert("보내는 사용자 ID와 받는 사용자 ID를 입력하세요.");
      return;
    }

    // WebSocket 연결 설정
    var socket = new SockJS('/chat');
    stompClient = Stomp.over(socket);
    stompClient.connect({}, function (frame) {
      document.getElementById("sender-id-input").disabled = true;
      document.getElementById("receiver-id-input").disabled = true;
      document.getElementById("message-input").disabled = false;
      document.getElementById("sender-id-input").style.backgroundColor = "#ccc";
      document.getElementById("receiver-id-input").style.backgroundColor = "#ccc";
      document.getElementById("message-input").style.backgroundColor = "#fff";

      // 채팅방 입장을 위해 서버로 senderId와 receiverId를 전송합니다.
      stompClient.send("/v1/chat/getRoomId", {}, JSON.stringify({
        receiver: receiverId,
        sender: senderId
      }));

      stompClient.subscribe('/topic/roomId/' + senderId, function (response) {
        roomId = response.body;
        console.log(roomId); // 확인용 로그

        getChatHistory();
        stompClient.subscribe('/topic/chatHistory/' + roomId, function (response) {
          var chatHistory = JSON.parse(response.body);
          displayChatHistory(chatHistory)
        });

        stompClient.subscribe('/topic/messages/' + roomId, function (response) {
          var message = JSON.parse(response.body);
          displayMessage(message.sender, message.content);

        });

      });

    });
  }

  function updateSendButtonStatus() {
    var inputElement = document.getElementById("message-input");
    var sendButton = document.getElementById("send-button");
    var message = inputElement.value.trim();
    sendButton.disabled = message === "";
  }

  function getChatHistory() {
    if (!roomId) {
      return;
    }
    stompClient.send("/v1/chat/join/" + roomId, {});
  }

  function displayChatHistory(chatHistory) {
    var chatBox = document.getElementById("chat-box");
    chatBox.innerHTML = ""; // 기존 채팅 내용 삭제

    chatHistory.forEach(function (chat) {
      displayMessage(chat.sender, chat.content);
    });
  }

  function sendMessage() {
    var inputElement = document.getElementById("message-input");
    var message = inputElement.value.trim();
    if (message !== "") {
      var payload = {
        sender: senderId,
        content: message
      };
      stompClient.send("/v1/chat/" + roomId, {}, JSON.stringify(payload));
      inputElement.value = "";
    }
  }

  function displayMessage(sender, content) {
    var chatBox = document.getElementById("chat-box");
    var messageElement = document.createElement("p");
    messageElement.textContent = sender + ": " + content;
    chatBox.appendChild(messageElement);
  }

  // 페이지가 로딩되면 WebSocket 연결을 시작합니다.
  document.addEventListener('DOMContentLoaded', function () {
    document.getElementById("message-input").addEventListener("input", updateSendButtonStatus);
    initWebSocket();
  });
</script>
</body>

</html>
